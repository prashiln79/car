<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MQTT Car Control</title>

<!-- External Libraries -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.1/dist/nipplejs.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; height: 100vh; margin: 0;
}
h2 { color: #333; text-align: center; margin-bottom: 6px; }
.hud { color: #444; font-size: 14px; text-align: center; margin-bottom: 16px; }

.controls {
  display: grid;
  grid-template-areas:
    ". forward ."
    "left stop right"
    ". backward .";
  gap: 12px;
}
#forward { grid-area: forward; }
#backward { grid-area: backward; }
#left { grid-area: left; }
#right { grid-area: right; }
#stop { grid-area: stop; }

button {
  width: 110px; height: 70px;
  border: none; border-radius: 14px;
  font-size: 17px; font-weight: 600;
  color: white; background: #4CAF50;
  box-shadow: 0 5px #388E3C;
  transition: 0.2s ease;
  user-select: none;
  touch-action: manipulation;
}
button:active { transform: scale(0.96); }
#stop { background: #f44336; box-shadow: 0 5px #c62828; }

.extra-controls {
  margin-top: 12px; display: flex; flex-wrap: wrap;
  gap: 10px; justify-content: center;
}
.extra-controls button {
  width: 130px; height: 60px; background: #2196f3; box-shadow: 0 5px #1565c0;
}
#controlModeToggle { background: #ff5722; box-shadow: 0 5px #d84315; }
#controlModeToggle.active { background: #4caf50; box-shadow: 0 5px #388e3c; }
#lightToggle.active { background: #ff9800; box-shadow: 0 5px #f57c00; }
#gyroToggle { background: #9c27b0; box-shadow: 0 5px #6a1b9a; }
#gyroToggle.active { background: #4caf50; box-shadow: 0 5px #388e3c; }

.speed-control { margin-top: 18px; text-align: center; }
.speed-control input { width: 240px; }
.speed-value { font-weight: 600; color: #333; margin-top: 4px; }

.joystick-container {
  margin-top: 25px; display: none; justify-content: center;
  transition: 0.3s ease; opacity: 0;
}
.joystick-container.active {
  display: flex; opacity: 1;
}
.joystick-zone {
  width: 150px;
  height: 150px;
  position: relative;  /* âœ… important for nipplejs positioning */
  border: 2px solid rgba(0, 0, 0, 0.2);
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  margin: 0 10px;
}
.joystick-label { text-align: center; margin-top: 8px; font-size: 14px; color: #333; }

@media (max-width: 600px) {
  button { width: 26vw; height: 65px; font-size: 15px; }
  #stop { width: 28vw; }
  .extra-controls button { width: 42vw; height: 60px; }
  .joystick-zone { width: 120px; height: 120px; }
}
</style>
</head>

<body>
  <h2>ðŸš— MQTT WiFi Car Control</h2>
  <div class="hud">Tap or hold buttons / use joystick / tilt phone</div>

  <!-- Button Control Grid -->
  <div class="controls" id="buttonControls">
    <button id="forward">Forward</button>
    <button id="backward">Backward</button>
    <button id="left">Left</button>
    <button id="right">Right</button>
    <button id="stop">Stop</button>
  </div>

  <!-- Extra Controls -->
  <div class="extra-controls">
    <button id="controlModeToggle">ðŸŽ® Joystick Mode</button>
    <button id="lightToggle">ðŸ’¤ Light Off</button>
    <button id="gyroToggle">ðŸ“± Enable Gyro</button>
  </div>

  <!-- Speed Control -->
  <div class="speed-control">
    <label for="speed">Speed</label><br>
    <input type="range" id="speed" min="0" max="255" value="255">
    <div class="speed-value">Speed: <span id="speedVal">255</span></div>
  </div>

  <!-- Dual Joystick -->
  <div class="joystick-container" id="joystickContainer">
    <div>
      <div id="joystick-left" class="joystick-zone"></div>
      <div class="joystick-label">Throttle</div>
    </div>
    <div>
      <div id="joystick-right" class="joystick-zone"></div>
      <div class="joystick-label">Steering</div>
    </div>
  </div>

<script>
/* ------------------ MQTT CONFIG ------------------ */
const client = mqtt.connect("wss://f31f59e872194305880111b99a249d12.s1.eu.hivemq.cloud:8884/mqtt", {
  username: "Prashil",
  password: "Prashil@n79",
  connectTimeout: 4000,
  reconnectPeriod: 2000,
  clean: true
});
client.on("connect", () => console.log("âœ… Connected to HiveMQ"));
function send(cmd) { console.log("âž¡ï¸", cmd); client.publish("car/control", cmd); }

/* ------------------ CORE CONTROL ------------------ */
const pressed = new Set();
const keyMap = { ArrowUp:"forward",KeyW:"forward",ArrowDown:"backward",KeyS:"backward",ArrowLeft:"left",KeyA:"left",ArrowRight:"right",KeyD:"right" };

document.addEventListener("keydown", e => {
  const cmd = keyMap[e.code]; if (!cmd) return;
  if (!pressed.has(cmd)) { pressed.add(cmd); evaluateMotion(); }
});
document.addEventListener("keyup", e => {
  const cmd = keyMap[e.code];
  if (cmd) { pressed.delete(cmd); evaluateMotion(); }
});

function evaluateMotion() {
  const f = pressed.has("forward"), b = pressed.has("backward"),
        l = pressed.has("left"), r = pressed.has("right");
  let cmd = "stop";
  if (f && l) cmd="forward_left";
  else if (f && r) cmd="forward_right";
  else if (b && l) cmd="backward_left";
  else if (b && r) cmd="backward_right";
  else if (f) cmd="forward";
  else if (b) cmd="backward";
  else if (l) cmd="left";
  else if (r) cmd="right";
  send(cmd);
}

/* ------------------ BUTTON CONTROLS ------------------ */
["forward","backward","left","right"].forEach(id=>{
  const btn=document.getElementById(id);
  btn.onmousedown=btn.ontouchstart=(e)=>{e.preventDefault(); pressed.add(id); evaluateMotion();};
  btn.onmouseup=btn.ontouchend=btn.onmouseleave=(e)=>{e.preventDefault(); pressed.delete(id); evaluateMotion();};
});
document.getElementById("stop").onclick=()=>{pressed.clear(); send("stop");};

/* ------------------ LIGHT TOGGLE ------------------ */
let lightOn=false;
const lightBtn=document.getElementById("lightToggle");
lightBtn.onclick=()=>{
  lightOn=!lightOn;
  lightBtn.textContent=lightOn?"ðŸ’¡ Light On":"ðŸ’¤ Light Off";
  lightBtn.classList.toggle("active",lightOn);
  send(lightOn?"light_on":"light_off");
};

/* ------------------ SPEED SLIDER ------------------ */
const speedSlider=document.getElementById("speed");
const speedVal=document.getElementById("speedVal");
speedSlider.oninput=()=>{
  speedVal.textContent=speedSlider.value;
  send(`speed:${speedSlider.value}`);
};

/* ------------------ JOYSTICK MODE ------------------ */
const modeToggle=document.getElementById("controlModeToggle");
const joystickContainer=document.getElementById("joystickContainer");
const buttonControls=document.getElementById("buttonControls");
let joystickLeft, joystickRight;

modeToggle.onclick=()=>{
  const active=!joystickContainer.classList.contains("active");
  modeToggle.textContent=active?"ðŸ•¹ Button Mode":"ðŸŽ® Joystick Mode";
  modeToggle.classList.toggle("active",active);
  joystickContainer.classList.toggle("active",active);
  buttonControls.style.display=active?"none":"grid";
  if(active) initDualJoysticks();
};

function initDualJoysticks() {
  if (joystickLeft) return;

  joystickLeft = nipplejs.create({
    zone: document.getElementById("joystick-left"),
    mode: "static",
    position: { left: "75px", top: "75px" }, // âœ… position relative to zone center
    color: "#4CAF50",
    size: 120
  });

  joystickRight = nipplejs.create({
    zone: document.getElementById("joystick-right"),
    mode: "static",
    position: { left: "75px", top: "75px" }, // âœ… same here
    color: "#2196F3",
    size: 120
  });

  joystickLeft.on("move", (e, data) => processJoystick(data, "left"));
  joystickLeft.on("end", () => resetJoystick("left"));
  joystickRight.on("move", (e, data) => processJoystick(data, "right"));
  joystickRight.on("end", () => resetJoystick("right"));
}

function processJoystick(data,side){
  const angle=data.angle?.degree||0, force=data.force||0;
  if(force<0.3){ resetJoystick(side); return; }
  if(side==="left"){
    pressed.delete("forward"); pressed.delete("backward");
    if(angle>45 && angle<135) pressed.add("forward");
    else if(angle>225 && angle<315) pressed.add("backward");
  }else{
    pressed.delete("left"); pressed.delete("right");
    if(angle>135 && angle<225) pressed.add("left");
    else if(angle<45 || angle>315) pressed.add("right");
  }
  evaluateMotion();
}
function resetJoystick(side){
  if(side==="left"){pressed.delete("forward");pressed.delete("backward");}
  else {pressed.delete("left");pressed.delete("right");}
  evaluateMotion();
}

/* ------------------ GYROSCOPE MODE ------------------ */
let gyroEnabled=false;
const gyroBtn=document.getElementById("gyroToggle");
gyroBtn.onclick=()=>{
  if(!gyroEnabled){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(res=>{
        if(res==='granted'){enableGyro();}
        else alert('Permission denied.');
      });
    } else enableGyro();
  } else disableGyro();
};
function enableGyro(){
  gyroEnabled=true; gyroBtn.textContent="ðŸ“± Disable Gyro"; gyroBtn.classList.add("active");
  window.addEventListener("deviceorientation", handleGyro);
}
function disableGyro(){
  gyroEnabled=false; gyroBtn.textContent="ðŸ“± Enable Gyro"; gyroBtn.classList.remove("active");
  window.removeEventListener("deviceorientation", handleGyro);
  ["forward","backward","left","right"].forEach(k=>pressed.delete(k));
  evaluateMotion();
}
function handleGyro(e){
  if(!gyroEnabled) return;
  const beta=e.beta||0, gamma=e.gamma||0, th=15;
  ["forward","backward","left","right"].forEach(k=>pressed.delete(k));
  if(beta<-th) pressed.add("forward");
  else if(beta>th) pressed.add("backward");
  if(gamma<-th) pressed.add("left");
  else if(gamma>th) pressed.add("right");
  evaluateMotion();
}
</script>
</body>
</html>
